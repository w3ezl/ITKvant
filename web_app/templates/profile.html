<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ current_user.last_name }} {{ current_user.first_name }}</title>
    <link rel="stylesheet" type="text/css" href="{{ static_versioned('style/main.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="icon" type="image/png" href="{{ static_versioned('img/favicon.png') }}" />
    
    {% if current_user == user %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    {% endif %}


    <meta property="og:title" content="IT-–∫–≤–∞–Ω—Ç—É–º | {{ current_user.last_name }} {{ current_user.first_name }}">
    <meta property="og:description" content="–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —É—á–∞—â–∏—Ö—Å—è IT-–∫–≤–∞–Ω—Ç—É–º–∞">
    <meta property="og:image" content="https://itkvantum.ru/static/img/og_image.png">
    <meta property="og:url" content="https://itkvantum.ru/profile/{{ user.id }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="IT-–∫–≤–∞–Ω—Ç—É–º">
</head>
<body>
    <div class="header">
        <div class="header_btns main_menu_btns">
            <a href="/dashboard">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a>
        </div>
        <a href="/profile/{{ current_user.id }}">
            <div class="header_profile">
                <img src="{{ static_versioned('uploads/avatars/'+current_user.id|string+'.png') }}">
                <p>
                    {{ current_user.last_name }}<br>
                    {{ current_user.first_name }}
                </p>
            </div>
        </a>
        <div class="profile_menu">
            <a href="/logout">–í—ã–π—Ç–∏</a>
        </div>

        <script>
        $(function() {
            let $profile = $(".header_profile");
            let $menu = $(".profile_menu");
            let timeout;

            function showMenu() {
                clearTimeout(timeout);
                $menu.stop(true, true).fadeIn(200);
            }

            function hideMenu() {
                timeout = setTimeout(function() {
                    $menu.stop(true, true).fadeOut(200);
                }, 200);
            }

            $profile.on("mouseenter", showMenu);
            $profile.on("mouseleave", hideMenu);

            $menu.on("mouseenter", showMenu);
            $menu.on("mouseleave", hideMenu);
        });
        </script>
    </div>
    <div class="main">
        <div class="main_profile">
            <div class="flex_container">
                <div class="avatar_block">
                    <img src="{{ static_versioned('uploads/avatars/'+user.id|string+'.png') }}" 
                         class="{{ 'your_avatar' if current_user == user else 'avatar' }}" 
                         id="avatarPreview">
                    {% if current_user == user %}
                        <input type="file" id="avatarInput" accept="image/*" style="display:none;">
                    {% endif %}
                </div>

                {% if current_user == user %}
                <div id="avatarModal">
                    <div class="avatarBlock">
                        <img id="cropImage">
                        <div class="cropButtons">
                            <div id="cropCancel">–û—Ç–º–µ–Ω–∞</div>
                            <div id="cropSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="info">
                    {{ user.last_name }} {{ user.first_name }}<br>
                    <span class="little">
                            <span id="status">
                                {{ "<–ü—É—Å—Ç–æ>" if not user.status else user.status }}
                            </span>
                            {% if current_user == user %}
                                <a href="#" id="status_link">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                            {% endif %}
                        <br>
                    {% if not user.is_teacher %}
                    –ì—Ä—É–ø–ø–∞: <span class="white">{{ user.group.name }}</span> <br>
                    –ù–∞—Å—Ç–∞–≤–Ω–∏–∫: <a href="/profile/{{ user.group.teacher.id}}"><span class="white">{{ user.group.teacher.first_name }} {{ user.group.teacher.father_name }}</span></a><br>
                    {% endif %}
                    </span>
                </div>
                {% if not user.is_teacher %}
                <div class="rating" id="rating{{ place }}">
                    –ú–µ—Å—Ç–æ: {{ place }} <br>
                    –ë–∞–ª–ª—ã —Ä–µ–π—Ç–∏–Ω–≥–∞: {{ user.rating_points }}
                </div>
                {% endif %}
            </div>
            <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
            <div class="achiv_container">
                {% for achiv in user.achievements %}
                <div class="achiv_card">
                    <img src="{{ static_versioned('uploads/achiv_icons/'+achiv.achievement.id|string+'.png') }}">
                    <div class="info">
                        <span class="title">{{ achiv.achievement.title }}</span>
                        <span class="desc">{{ achiv.achievement.description }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
    function showToast(message, duration=2000) {
        const $toast = $("#toast");
        $toast.text(message).fadeIn(200);

        setTimeout(() => {
            $toast.fadeOut(200);
        }, duration);
    }
    </script>

    <script>
    $(function() {
        const $status = $("#status");
        const $link = $("#status_link");

        $link.on("click", function(e) {
            e.preventDefault();

            // –£–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è
            if ($status.find("input").length) return;

            $link.hide();

            const currentText = $status.text().trim() === "<–ü—É—Å—Ç–æ>" ? "" : $status.text().trim();

            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω–ø—É—Ç–∞ –∏ —Å—á—ë—Ç—á–∏–∫–∞
            const $wrapper = $('<div class="status-edit-wrapper"></div>').css({
                display: 'inline-flex',
                'align-items': 'center',
                'gap': '8px'
            });

            // –ò–Ω–ø—É—Ç
            const $input = $('<input type="text" id="status_input" maxlength="150">')
                .val(currentText)
                .css({
                    'background': 'transparent',
                    'border': '1px solid #ccc',
                    'color': '#fff8',
                    'font-size': '12px',
                    'padding': '2px 4px',
                    'border-radius': '4px',
                    'width': '100%',
                    'max-width': '300px'
                });

            // –°—á—ë—Ç—á–∏–∫
            const $counter = $('<span class="status-counter"></span>').css({
                'font-size': '11px',
                'color': '#aaa'
            }).text(150 - currentText.length);

            $wrapper.append($input, $counter);
            $status.empty().append($wrapper);
            $input.focus();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
            $input.on("input", function() {
                const remaining = 150 - $(this).val().length;
                $counter.text(remaining);
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Enter
            $input.on("keypress", function(e) {
                if (e.which === 13) {
                    saveStatus($(this).val().trim());
                }
            });

            // Escape ‚Üí –æ—Ç–º–µ–Ω–∞
            $input.on("keydown", function(e) {
                if (e.key === "Escape") {
                    cancelEdit();
                }
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
            $input.on("blur", function() {
                saveStatus($(this).val().trim());
            });

            function saveStatus(newStatus) {
                $.post("/update_status", { status: newStatus }, function() {
                    $status.text(newStatus || "<–ü—É—Å—Ç–æ>");
                    $link.show();
                    showToast("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω");
                }).fail(function() {
                    showToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞");
                    $status.text(currentText || "<–ü—É—Å—Ç–æ>");
                    $link.show();
                });
            }

            function cancelEdit() {
                $status.text(currentText || "<–ü—É—Å—Ç–æ>");
                $link.show();
            }
        });
    });
    </script>

    {% if current_user == user %}
    <script>
      const avatar = document.getElementById("avatarPreview");
      const input = document.getElementById("avatarInput");
      const modal = document.getElementById("avatarModal");
      const cropImage = document.getElementById("cropImage");
      const cropSave = document.getElementById("cropSave");
      const cropCancel = document.getElementById("cropCancel");
      let cropper;

      // üìå –ö–ª–∏–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä–∫–µ ‚Üí –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
      avatar.addEventListener("click", () => {
        input?.click();
      });

      // üìå –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ cropper
      input?.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          cropImage.src = ev.target.result;
          modal.style.display = "flex";

          if (cropper) cropper.destroy();
          cropper = new Cropper(cropImage, {
            aspectRatio: 1,
            viewMode: 1,
          });
        };
        reader.readAsDataURL(file);
      });

      // üìå –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
      cropSave.addEventListener("click", () => {
        cropper.getCroppedCanvas({ width: 300, height: 300 })
          .toBlob((blob) => {
            const formData = new FormData();
            formData.append("avatar", blob, "avatar.png");

            fetch("/update_avatar", {
              method: "POST",
              body: formData
            })
            .then(res => res.json())
            .then(data => {
              if (data.url) {
                avatar.src = data.url + "?v=" + Date.now(); // —Å–±—Ä–æ—Å –∫—ç—à–∞
                showToast("–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω");
              } else {
                showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", 3000);
              }
              modal.style.display = "none";
              cropper.destroy();
            });
          }, "image/png");
      });

      cropCancel.addEventListener("click", () => {
        modal.style.display = "none";
        if (cropper) cropper.destroy();
      });
    </script>
    {% endif %}




</body>
</html>